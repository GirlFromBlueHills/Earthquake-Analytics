<!DOCTYPE html>
<Head>
    <H1><center>Earthquake Overview</center></H1>
    <meta charset="utf-8">
    <style>

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .dot {
            stroke: #000;
        }

        .land {
            fill: #999;
            stroke-opacity: 1;
        }

        circle {
            fill: rgba(255, 0, 0, 0.5);
        }

        body {
            height: 1000px;
            width: 1920px;
            overflow: scroll;
        }

        div.ball, div.scatterplot div.background{
            position: relative;
            float: left;
            height: 500px;
            width: 960px;
        }
        .tooltip {
            position: absolute;
            width: 200px;
            height: 28px;
            pointer-events: none;
            background: white;
            opacity: 1;
        }

        .earth_tooltip {
            position: absolute;
            width: 300px;
            height: 28px;
            pointer-events: none;
            opacity: 1;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }




    </style>
</Head>
<body>
<button onclick="previousPage();">Back</button>
<button onclick="nextPage();">Continue</button>

<div id="option">
    <input id="playOrStop"
           type="button"
           value="Play Or Stop" />
</div>
<div class = "ball" id = "ball"></div>
<div class = "scatterplot" id = "scatterplot"></div>
<div id = "tooltip"></div>
<div class = "background"><H1 style="text-align: center;">Is there a correlation between the earthquake's magnitude and its depth?</H1>
    "The simple answer is that the largest earthquakes occur at shallower depths in the earth's crust, but smaller earthquakes can and do occur at all depths down to about 700 km (400 mi).
    Earthquakes occur in the earth's crust, the topmost layer of the earth, which is typically 7 to 30 km (4 to 18 mi) thick. The crust is the coldest and most brittle part of the earth, and has many fault systems on which earthquakes occur. These earthquakes are caused by the buildup of tectonic stress, and result in frictional sliding on the faults.
    Earthquakes also occur in the parts of the tectonic plates that are being pushed down into the earth, called subducting slabs. These slabs are known to penetrate down to depths of 700 km (400 mi) or so. At these depths, the higher temperatures make rock softer. It is not yet understood how frictional sliding can occur there, but earthquakes still occur. An alternative explanation may be that those deep earthquakes are caused by some kind of "phase transition", where the physical structure of the rocks suddenly changes to a different state.
    Smaller magnitude earthquakes, those that have magnitudes less than about 7, are known to occur in both the crust and in the subducting slabs. Larger magnitude earthquakes, those having magnitudes up to the largest observed magnitude of 9.5 (1960 Chile earthquake), typically occur within the earth's crust. These large and great earthquakes are associated with frictional sliding on faults, which can only occur at colder temperatures."
    </br></br>                                 ---- Ref: <a href="http://www.openhazards.com/faq/earthquakes-faults-plate-tectonics-earth-structure-user-submitted-questions/there-correlation">http://www.openhazards.com/faq/earthquakes-faults-plate-tectonics-earth-structure-user-submitted-questions/there-correlation</a>
</div>


<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<script src="js/Scatterplot.js"></script>
<script>
    function previousPage(){
        window.location='EarthquakeOverView.html';
    }
    function nextPage(){
        window.location='fracking_vs_earthquakes.html';
    }

    d3.select(window)
            .on("mousemove", mousemove)
            .on("mouseup", mouseup);

    var width = 960,
            height = 500;

    var proj = d3.geo.orthographic()
            .translate([width / 2, height / 2])
            .clipAngle(90)
            .scale(220);

    var pointpath = function(d, r) {
        var pr = d3.geo.path().projection(proj).pointRadius(r);
        return pr({type: "Point", coordinates: [d.lon, d.lat]})
    }


    var i = -1,n;


    var path = d3.geo.path().projection(proj).pointRadius(2);

    var rotate = d3_geo_greatArcInterpolator();

    var svg = d3.select("#ball").append("svg")
            .attr("width", width)
            .attr("height", height)
            .on("mousedown", mousedown);


    var probe = d3.select("#ball").append("div")
            .attr("id","probe")
            .attr("class", "earth_tooltip");

    var isPlay = true;
    var point = d3.geo.circle();

    var title;

    var position;

    queue()
            .defer(d3.json,"json/world-110m2.json")
            .defer(d3.csv,"csv/earthquake.csv")
            .await(ready);

    function ready(error, world, places) {
        n = places.length;
        position = places;
//        startAnimation();
//        d3.select('#playOrStop').on('click', function () {
//            if (done) startAnimation(); else stopAnimation();
//        });



    var ocean_fill = svg.append("defs").append("radialGradient")
                .attr("id", "ocean_fill")
                .attr("cx", "75%")
                .attr("cy", "25%");
        ocean_fill.append("stop").attr("offset", "5%").attr("stop-color", "#fff");
        ocean_fill.append("stop").attr("offset", "100%").attr("stop-color", "blue");

        var globe_highlight = svg.append("defs").append("radialGradient")
                .attr("id", "globe_highlight")
                .attr("cx", "75%")
                .attr("cy", "25%");
        globe_highlight.append("stop")
                .attr("offset", "5%").attr("stop-color", "#ffd")
                .attr("stop-opacity","0.6");
        globe_highlight.append("stop")
                .attr("offset", "100%").attr("stop-color", "#ba9")
                .attr("stop-opacity","0.2");

        var globe_shading = svg.append("defs").append("radialGradient")
                .attr("id", "globe_shading")
                .attr("cx", "55%")
                .attr("cy", "45%");
        globe_shading.append("stop")
                .attr("offset","30%").attr("stop-color", "#fff")
                .attr("stop-opacity","0")
        globe_shading.append("stop")
                .attr("offset","100%").attr("stop-color", "#505962")
                .attr("stop-opacity","0.3")

        var drop_shadow = svg.append("defs").append("radialGradient")
                .attr("id", "drop_shadow")
                .attr("cx", "50%")
                .attr("cy", "50%");
        drop_shadow.append("stop")
                .attr("offset","20%").attr("stop-color", "#000")
                .attr("stop-opacity",".5")
        drop_shadow.append("stop")
                .attr("offset","100%").attr("stop-color", "#000")
                .attr("stop-opacity","0")

        svg.append("ellipse")
                .attr("cx", 440).attr("cy", 450)
                .attr("rx", proj.scale()*.90)
                .attr("ry", proj.scale()*.25)
                .attr("class", "noclicks")
                .style("fill", "url(#drop_shadow)");

        svg.append("circle")
                .attr("cx", width / 2).attr("cy", height / 2)
                .attr("r", proj.scale())
                .attr("class", "noclicks")
                .style("fill", "url(#ocean_fill)");

        svg.append("path")
                .datum(topojson.object(world, world.objects.land))
                .attr("class", "land noclicks")
                .attr("d", path);

        svg.append("circle")
                .attr("cx", width / 2).attr("cy", height / 2)
                .attr("r", proj.scale())
                .attr("class","noclicks")
                .style("fill", "url(#globe_highlight)");

        svg.append("circle")
                .attr("cx", width / 2).attr("cy", height / 2)
                .attr("r", proj.scale())
                .attr("class","noclicks")
                .style("fill", "url(#globe_shading)");


        //draw points on the sphere

        point = svg.selectAll(".dot").data(places);
        var time, mag;
        point.enter().append("path")
                .attr("class", "point")
                .datum(function(d) { return {
                    type: "Point",
                    coordinates: [d.longitude, d.latitude],
                    time: d.time,
                    mag: d.mag
                }; })
                .on("mousemove",function(d){
                    setProbeContent(d);
                    probe
                            .style( {
                                "display" : "block",
                                "top" : (d3.event.pageY - 80) + "px",
                                "left" : (d3.event.pageX + 10) + "px"
                            })
                })
                .on("mouseout",function(){
                    hoverData = null;
                    probe.style("display","none");
                })
                .attr("d", path)
                .style("opacity", 0)
                .attr("fill", "red" );

        function setProbeContent(d){

            var html = "Time: "+new Date(d["time"])+"</br>"+"Longitude: "+ d.coordinates[0]+"   "+"Latitude: "+ d.coordinates[1]+"</br>"+"Magnitude: "+ d.mag+"</br>";
            probe
                    .html( html );
        }

        title = svg.append("text")
                .attr("x", 1*width / 5)
                .attr("y", height * 1 / 20);


        //rotation animation

        startAnimation();
        d3.select('#playOrStop').on('click', function () {
            if (isPlay){
                isPlay = false;
            }else{
                isPlay = true;
            }
            startAnimation();
        });




    }


    function refresh() {
        svg.selectAll(".land").attr("d", path);
        svg.selectAll(".point").attr("d", path);


    }

    function startAnimation() {

        if (--i <= 0) i = n-1;
        if(isPlay == false){
            title.text("");
            point.style("opacity",0.3);
            return;
        }
        title.text(new Date(position[i].time)+"\r\n"+"Longitude: "+ position[i].longitude +" Latitude: "+ position[i].latitude+"\n"+ " Magnitude: " + position[i].mag);

        point.transition()
                .style("opacity", function(d, j) { return j === i ? "1":"0" ; })
        ;

        d3.transition()
                .delay(250)
                .duration(1500)
                .tween("rotate", function() {
                    var p = [position[i].longitude,position[i].latitude];
                    rotate.source(proj.rotate()).target([-p[0], -p[1]]).distance();
                    return function(t) {
                        proj.rotate(rotate(t));
                        svg.selectAll(".land").attr("d", path);
                        svg.selectAll(".point").attr("d", path);
                    };
                })
                .transition()
                .each("end", startAnimation);
    }


    // modified from http://bl.ocks.org/1392560
    var m0, o0;
    function mousedown() {
        isPlay = false;
        m0 = [d3.event.pageX, d3.event.pageY];
        o0 = proj.rotate();
        d3.event.preventDefault();
    }
    function mousemove() {
        if (m0) {
            var m1 = [d3.event.pageX, d3.event.pageY]
                    , o1 = [o0[0] + (m1[0] - m0[0]) / 6, o0[1] + (m0[1] - m1[1]) / 6];
            o1[1] = o1[1] > 30  ? 30  :
                    o1[1] < -30 ? -30 :
                            o1[1];
            proj.rotate(o1);
            svg.selectAll("path.point").attr("d", function(d) {return pointpath(d, d.r)});
            refresh();
        }
    }
    function mouseup() {
        if (m0) {
            mousemove();
            m0 = null;
        }
    }

    //display rotation animation with earthquake happening

    var d3_radians = Math.PI / 180;

    function d3_geo_greatArcInterpolator() {
        var x0, y0, cy0, sy0, kx0, ky0,
                x1, y1, cy1, sy1, kx1, ky1,
                d,
                k;

        function interpolate(t) {
            var B = Math.sin(t *= d) * k,
                    A = Math.sin(d - t) * k,
                    x = A * kx0 + B * kx1,
                    y = A * ky0 + B * ky1,
                    z = A * sy0 + B * sy1;
            return [
                        Math.atan2(y, x) / d3_radians,
                        Math.atan2(z, Math.sqrt(x * x + y * y)) / d3_radians
            ];
        }

        interpolate.distance = function() {
            if (d == null) k = 1 / Math.sin(d = Math.acos(Math.max(-1, Math.min(1, sy0 * sy1 + cy0 * cy1 * Math.cos(x1 - x0)))));
            return d;
        };

        interpolate.source = function(_) {
            var cx0 = Math.cos(x0 = _[0] * d3_radians),
                    sx0 = Math.sin(x0);
            cy0 = Math.cos(y0 = _[1] * d3_radians);
            sy0 = Math.sin(y0);
            kx0 = cy0 * cx0;
            ky0 = cy0 * sx0;
            d = null;
            return interpolate;
        };

        interpolate.target = function(_) {
            var cx1 = Math.cos(x1 = _[0] * d3_radians),
                    sx1 = Math.sin(x1);
            cy1 = Math.cos(y1 = _[1] * d3_radians);
            sy1 = Math.sin(y1);
            kx1 = cy1 * cx1;
            ky1 = cy1 * sx1;
            d = null;
            return interpolate;
        };

        return interpolate;
    }



</script>
</body>
</html>